# 项目架构文档

## 系统架构概述

双AI讨论系统采用模块化设计，将功能分解为独立的模块，便于维护和扩展。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层                                │
├─────────────────────────────────────────────────────────────┤
│  cli_interface.py  │  main.py  │  run.py                   │
│  (命令行界面)      │  (主入口)  │  (启动脚本)               │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层                                │
├─────────────────────────────────────────────────────────────┤
│  discussion_engine.py  │  api_client.py                    │
│  (讨论引擎)           │  (API客户端)                       │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    配置管理层                                │
├─────────────────────────────────────────────────────────────┤
│  config.py  │  config_manager.py  │  prompt_generator.py   │
│  (配置类)   │  (配置管理器)       │  (提示词生成器)         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层                                │
├─────────────────────────────────────────────────────────────┤
│  config.ini  │  requirements.txt  │  discussion_*.txt      │
│  (配置文件)  │  (依赖列表)        │  (讨论记录)             │
└─────────────────────────────────────────────────────────────┘
```

## 模块详细说明

### 1. 用户界面层

#### cli_interface.py
- **职责**：提供命令行用户界面
- **功能**：
  - 显示彩色界面和进度
  - 处理用户输入和配置
  - 展示讨论过程和结果
- **依赖**：discussion_engine.py, config.py

#### main.py
- **职责**：程序主入口点
- **功能**：启动CLI界面
- **依赖**：cli_interface.py

#### run.py
- **职责**：快速启动脚本
- **功能**：提供多种启动选项
- **依赖**：cli_interface.py

### 2. 业务逻辑层

#### discussion_engine.py
- **职责**：讨论引擎核心逻辑
- **功能**：
  - 管理讨论流程
  - 控制AI对话轮次
  - 检测结束条件
  - 保存讨论记录
- **依赖**：config.py, api_client.py

#### api_client.py
- **职责**：API客户端
- **功能**：
  - 处理与AI模型的API交互
  - 错误处理和重试机制
  - 连接测试
- **依赖**：config.py

### 3. 配置管理层

#### config.py
- **职责**：配置管理主类
- **功能**：
  - 管理讨论参数
  - 生成系统提示词
  - 变量验证
- **依赖**：config_manager.py, prompt_generator.py

#### config_manager.py
- **职责**：配置文件管理器
- **功能**：
  - 读取和解析config.ini
  - 管理API配置
  - 管理提示词模板
- **依赖**：无

#### prompt_generator.py
- **职责**：提示词生成器
- **功能**：
  - 动态变量替换
  - 生成情境感知提示词
  - 支持多种提示词类型
- **依赖**：config_manager.py

### 4. 数据存储层

#### config.ini
- **职责**：系统配置文件
- **内容**：
  - API配置
  - 提示词模板
  - 系统参数
  - 界面设置

#### requirements.txt
- **职责**：依赖包列表
- **内容**：Python包依赖

## 数据流

### 1. 系统启动流程
```
run.py → main.py → cli_interface.py → config.py → config_manager.py
```

### 2. 讨论执行流程
```
用户输入 → cli_interface.py → discussion_engine.py → api_client.py → AI模型
```

### 3. 提示词生成流程
```
discussion_engine.py → config.py → prompt_generator.py → config_manager.py → config.ini
```

## 设计原则

### 1. 单一职责原则
每个模块都有明确的单一职责，便于维护和测试。

### 2. 依赖倒置原则
高层模块不依赖低层模块，都依赖于抽象。

### 3. 开闭原则
对扩展开放，对修改关闭。可以通过修改配置文件来改变行为。

### 4. 配置分离
将配置信息从代码中分离出来，便于管理和修改。

## 扩展点

### 1. 新增AI模型支持
- 修改api_client.py
- 更新config.ini中的API配置

### 2. 新增提示词模板
- 修改config.ini中的提示词模板
- 更新prompt_generator.py中的变量支持

### 3. 新增用户界面
- 创建新的界面模块
- 实现与discussion_engine.py的接口

### 4. 新增讨论规则
- 修改discussion_engine.py
- 更新结束条件检测逻辑

## 性能考虑

### 1. API调用优化
- 实现请求缓存
- 添加重试机制
- 控制并发数量

### 2. 内存管理
- 及时清理讨论历史
- 限制最大轮数
- 优化数据结构

### 3. 用户体验
- 添加进度显示
- 实现异步处理
- 提供取消功能

## 安全考虑

### 1. API密钥安全
- 使用环境变量
- 避免硬编码
- 实现密钥轮换

### 2. 输入验证
- 验证用户输入
- 防止注入攻击
- 限制输入长度

### 3. 错误处理
- 优雅处理异常
- 记录错误日志
- 提供用户友好的错误信息
